name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual backup

jobs:
  backup-database:
    name: Backup Production Database
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create database backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "=== Starting database backup ==="

            # Configuration
            BACKUP_DIR="/backups/imperiocasino/database"
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/db_backup_$DATE.sql"
            DB_NAME="${{ secrets.DB_NAME || 'imperiocasino_prod' }}"
            DB_USER="${{ secrets.DB_USER || 'imperio_user' }}"

            # Create backup directory
            mkdir -p "$BACKUP_DIR"

            # Create backup
            echo "Creating PostgreSQL backup..."
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" pg_dump \
              -h localhost \
              -U "$DB_USER" \
              -d "$DB_NAME" \
              -F c \
              -b \
              -v \
              -f "$BACKUP_FILE.dump"

            # Also create SQL format for easier inspection
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" pg_dump \
              -h localhost \
              -U "$DB_USER" \
              -d "$DB_NAME" \
              > "$BACKUP_FILE"

            # Compress backups
            echo "Compressing backups..."
            gzip "$BACKUP_FILE"
            gzip "$BACKUP_FILE.dump"

            # Verify backup
            echo "Verifying backup..."
            if [ -f "$BACKUP_FILE.gz" ] && [ -s "$BACKUP_FILE.gz" ]; then
              echo "✅ Backup created successfully: $BACKUP_FILE.gz"
              ls -lh "$BACKUP_FILE.gz"
            else
              echo "❌ Backup verification failed"
              exit 1
            fi

            # Clean up old backups (keep last 30 days)
            echo "Cleaning up old backups..."
            find "$BACKUP_DIR" -name "*.gz" -mtime +30 -delete

            # Count remaining backups
            BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/*.gz 2>/dev/null | wc -l)
            echo "Total backups remaining: $BACKUP_COUNT"

            echo "=== Backup completed successfully ==="

      - name: Upload backup to S3 (optional)
        if: false  # Enable this if using AWS S3
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Upload to S3
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="/backups/imperiocasino/database/db_backup_$DATE.sql.gz"

            if [ -f "$BACKUP_FILE" ]; then
              aws s3 cp "$BACKUP_FILE" \
                s3://${{ secrets.S3_BACKUP_BUCKET }}/database/ \
                --storage-class GLACIER
              echo "✅ Backup uploaded to S3"
            fi

      - name: Test backup restoration (weekly)
        if: github.event.schedule == '0 2 * * 0'  # Run on Sundays only
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "=== Testing backup restoration ==="

            # Find latest backup
            LATEST_BACKUP=$(ls -t /backups/imperiocasino/database/*.sql.gz | head -1)

            if [ -z "$LATEST_BACKUP" ]; then
              echo "❌ No backup found for restoration test"
              exit 1
            fi

            echo "Testing restoration of: $LATEST_BACKUP"

            # Create test database
            TEST_DB="imperiocasino_restore_test"
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" dropdb -h localhost -U "${{ secrets.DB_USER }}" --if-exists "$TEST_DB"
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" createdb -h localhost -U "${{ secrets.DB_USER }}" "$TEST_DB"

            # Restore to test database
            gunzip -c "$LATEST_BACKUP" | PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql -h localhost -U "${{ secrets.DB_USER }}" -d "$TEST_DB"

            # Verify restoration
            TABLE_COUNT=$(PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql -h localhost -U "${{ secrets.DB_USER }}" -d "$TEST_DB" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")

            if [ "$TABLE_COUNT" -gt 0 ]; then
              echo "✅ Backup restoration test successful ($TABLE_COUNT tables restored)"
            else
              echo "❌ Backup restoration test failed"
              exit 1
            fi

            # Clean up test database
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" dropdb -h localhost -U "${{ secrets.DB_USER }}" "$TEST_DB"

            echo "=== Restoration test completed ==="

  backup-files:
    name: Backup Application Files
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Create file backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "=== Starting file backup ==="

            BACKUP_DIR="/backups/imperiocasino/files"
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/app_backup_$DATE.tar.gz"
            APP_DIR="${{ secrets.DEPLOY_PATH || '/var/www/imperiocasino' }}"

            # Create backup directory
            mkdir -p "$BACKUP_DIR"

            # Create tar backup (exclude venv, __pycache__, logs)
            echo "Creating application backup..."
            tar -czf "$BACKUP_FILE" \
              --exclude="venv" \
              --exclude="__pycache__" \
              --exclude="*.pyc" \
              --exclude="logs" \
              --exclude=".git" \
              -C "$(dirname $APP_DIR)" \
              "$(basename $APP_DIR)"

            # Verify backup
            if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
              echo "✅ File backup created: $BACKUP_FILE"
              ls -lh "$BACKUP_FILE"
            else
              echo "❌ File backup failed"
              exit 1
            fi

            # Clean up old backups (keep last 7 days)
            find "$BACKUP_DIR" -name "*.tar.gz" -mtime +7 -delete

            echo "=== File backup completed ==="

  backup-report:
    name: Backup Status Report
    runs-on: ubuntu-latest
    needs: [backup-database, backup-files]
    if: always()

    steps:
      - name: Generate backup report
        run: |
          echo "=== Backup Status Report ==="
          echo "Database Backup: ${{ needs.backup-database.result }}"
          echo "File Backup: ${{ needs.backup-files.result }}"

          if [ "${{ needs.backup-database.result }}" == "success" ] && [ "${{ needs.backup-files.result }}" == "success" ]; then
            echo "✅ All backups completed successfully"
          else
            echo "❌ Some backups failed"
            exit 1
          fi

      - name: Send notification (optional)
        if: failure()
        run: |
          # Add notification logic here (e.g., email, Slack, etc.)
          echo "⚠️ Backup failed - notification should be sent"
